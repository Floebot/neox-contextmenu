(function(){'use strict';const CONFIG={menuId:'customContextMenu',menuWidth:180,backdropBlur:'5px',opacity:0.95};let isFullscreen=false;let clipboardText='';let contextMenu=null;let copyItem=null;let cutItem=null;let pasteItem=null;let selectAllItem=null;let selectSeparator=null;let fullscreenItem=null;let fullscreenStatus=null;let isMenuVisible=false;let contextMenuTarget=null;let savedSelection=null;const styles=`.context-menu{position:fixed;background:rgba(30,30,30,${CONFIG.opacity});backdrop-filter:blur(${CONFIG.backdropBlur});-webkit-backdrop-filter:blur(${CONFIG.backdropBlur});border:1px solid rgba(255,255,255,0.1);border-radius:5px;padding:4px 0;min-width:${CONFIG.menuWidth}px;display:none;z-index:10000}.context-menu-item{padding:8px 20px;color:#e0e0e0;font-size:13px;cursor:pointer;transition:background-color 0.1s;display:flex;align-items:center;justify-content:space-between}.context-menu-item:hover{background:rgba(42,42,42,0.8)}.context-menu-item.disabled{color:#505050;cursor:default}.context-menu-item.disabled:hover{background:transparent}.context-menu-separator{height:1px;background:rgba(255,255,255,0.08);margin:4px 0}.shortcut{color:#707070;font-size:11px;margin-left:20px}`;const menuHTML=`<div id="${CONFIG.menuId}"class="context-menu"><div class="context-menu-item"id="selectAllItem"data-action="selectAll"><span>选择全部</span><span class="shortcut">Ctrl+A</span></div><div class="context-menu-separator"id="selectSeparator"></div><div class="context-menu-item"id="cutItem"data-action="cut"><span>剪切</span><span class="shortcut">Ctrl+X</span></div><div class="context-menu-item"id="copyItem"data-action="copy"><span>复制</span><span class="shortcut">Ctrl+C</span></div><div class="context-menu-item"id="pasteItem"data-action="paste"><span>粘贴</span><span class="shortcut">Ctrl+V</span></div><div class="context-menu-separator"></div><div class="context-menu-item"id="fullscreenItem"data-action="fullscreen"><span>全屏</span></div></div>`;function isTauriEnvironment(){return typeof window!=='undefined'&&window.__TAURI__}function getClipboardAPI(){if(isTauriEnvironment()){return window.__TAURI__.clipboardManager}return null}function init(){const styleElement=document.createElement('style');styleElement.textContent=styles;document.head.appendChild(styleElement);const tempDiv=document.createElement('div');tempDiv.innerHTML=menuHTML;document.body.appendChild(tempDiv.firstElementChild);contextMenu=document.getElementById(CONFIG.menuId);copyItem=document.getElementById('copyItem');cutItem=document.getElementById('cutItem');pasteItem=document.getElementById('pasteItem');selectAllItem=document.getElementById('selectAllItem');selectSeparator=document.getElementById('selectSeparator');fullscreenItem=document.getElementById('fullscreenItem');fullscreenStatus=document.getElementById('fullscreenStatus');bindEvents()}function bindEvents(){document.addEventListener('contextmenu',handleContextMenu);document.addEventListener('click',hideContextMenu);window.addEventListener('scroll',hideContextMenu);document.addEventListener('wheel',hideContextMenu,{passive:true});window.addEventListener('blur',hideContextMenu);contextMenu.addEventListener('click',(e)=>e.stopPropagation());contextMenu.querySelectorAll('.context-menu-item').forEach(item=>{item.addEventListener('click',handleMenuItemClick)});document.addEventListener('keydown',handleKeyboard);document.addEventListener('fullscreenchange',handleFullscreenChange)}function handleContextMenu(e){e.preventDefault();const target=e.target;const isTextInput=target.tagName==='INPUT'||target.tagName==='TEXTAREA';const isTextDiv=target.classList.contains('text')||target.closest('.text');const isContentEditable=target.contentEditable==='true'||target.closest('[contenteditable="true"]');if(isTextInput||isTextDiv||isContentEditable){contextMenuTarget=target;savedSelection=null;if(isTextInput){try{savedSelection={start:target.selectionStart||0,end:target.selectionEnd||0}}catch(e){const selection=window.getSelection();if(selection.toString()){savedSelection={start:0,end:selection.toString().length}}else{savedSelection={start:0,end:0}}}}else{const selection=window.getSelection();if(selection.rangeCount>0){savedSelection=selection.getRangeAt(0).cloneRange()}}showContextMenu(e)}}async function checkClipboardContent(){const clipboardAPI=getClipboardAPI();if(!clipboardAPI)return false;try{const text=await clipboardAPI.readText();return text&&text.length>0}catch(error){console.error('检查剪贴板内容失败:',error);return false}}async function checkClipboardForPositiveInteger(){const clipboardAPI=getClipboardAPI();if(!clipboardAPI)return false;try{const text=await clipboardAPI.readText();return/^[1-9]\d*$/.test(text.trim())}catch(error){console.error('检查剪贴板内容失败:',error);return false}}async function showContextMenu(e){const target=contextMenuTarget;if(!target)return;const isTextInput=target.tagName==='INPUT'||target.tagName==='TEXTAREA';const isEditable=isTextInput||target.contentEditable==='true'||target.classList.contains('text');let hasSelection=false;if(isTextInput){if(target.type==='number'){const selection=window.getSelection();hasSelection=selection.toString().length>0}else{hasSelection=(savedSelection&&savedSelection.start!==savedSelection.end)}}else{hasSelection=savedSelection&&!savedSelection.collapsed}const hasClipboardContent=await checkClipboardContent();const isInChatView=target.closest('.chat-view')!==null;let disableCut=false;let disableCopy=false;let disablePaste=false;let requirePositiveInteger=false;if(target.tagName==='INPUT'){const inputType=target.type;if(inputType==='range'){disableCut=true;disableCopy=true;disablePaste=true}else if(inputType==='password'){disableCut=true;disableCopy=true}else if(inputType==='number'){disableCut=true;disablePaste=true}}let hasValidClipboardContent=hasClipboardContent;if(requirePositiveInteger){hasValidClipboardContent=await checkClipboardForPositiveInteger()}const isStandardTextInput=()=>{if(target.tagName==='TEXTAREA'){return true}if(target.tagName==='INPUT'){const textInputTypes=['text','password','search','email','url'];return textInputTypes.includes(target.type)}return false};const shouldShowSelectAll=isStandardTextInput();if(shouldShowSelectAll){selectAllItem.style.display='flex';selectSeparator.style.display='block';const hasContent=target.value.length>0;selectAllItem.classList.toggle('disabled',!hasContent)}else{selectAllItem.style.display='none';selectSeparator.style.display='none'}copyItem.classList.toggle('disabled',!hasSelection||disableCopy);cutItem.classList.toggle('disabled',!(isTextInput&&hasSelection)||disableCut);pasteItem.classList.toggle('disabled',!hasValidClipboardContent||isInChatView||disablePaste);updateFullscreenMenuItem();let x=e.clientX;let y=e.clientY;contextMenu.style.display='block';contextMenu.style.visibility='hidden';const menuRect=contextMenu.getBoundingClientRect();const menuHeight=menuRect.height;if(x+CONFIG.menuWidth>window.innerWidth){x=window.innerWidth-CONFIG.menuWidth-5}if(y+menuHeight>window.innerHeight){if(y-menuHeight>0){y=y-menuHeight}else{y=5}}if(x<0)x=5;if(y<0)y=5;contextMenu.style.left=x+'px';contextMenu.style.top=y+'px';contextMenu.style.visibility='visible';isMenuVisible=true}function hideContextMenu(){if(contextMenu&&isMenuVisible){contextMenu.style.display='none';contextMenu.style.visibility='visible';isMenuVisible=false}}function updateFullscreenMenuItem(){if(isFullscreen){fullscreenItem.querySelector('span:first-child').textContent='退出全屏'}else{fullscreenItem.querySelector('span:first-child').textContent='全屏'}}function handleMenuItemClick(e){const item=e.currentTarget;const action=item.dataset.action;if(item.classList.contains('disabled')){return}switch(action){case'copy':copyText();break;case'paste':pasteText();break;case'cut':cutText();break;case'selectAll':selectAllText();break;case'fullscreen':toggleFullscreen();break}hideContextMenu()}function selectAllText(){if(!contextMenuTarget)return;contextMenuTarget.focus();if(contextMenuTarget.tagName==='INPUT'||contextMenuTarget.tagName==='TEXTAREA'){contextMenuTarget.setSelectionRange(0,contextMenuTarget.value.length)}}async function copyText(){const clipboardAPI=getClipboardAPI();if(!clipboardAPI||!contextMenuTarget)return;try{let textToCopy='';if(contextMenuTarget.tagName==='INPUT'||contextMenuTarget.tagName==='TEXTAREA'){if(contextMenuTarget.type==='number'){const selection=window.getSelection();textToCopy=selection.toString()}else{const selection=savedSelection||{start:contextMenuTarget.selectionStart||0,end:contextMenuTarget.selectionEnd||0};textToCopy=contextMenuTarget.value.substring(selection.start,selection.end)}}else{if(savedSelection){const selection=window.getSelection();selection.removeAllRanges();selection.addRange(savedSelection.cloneRange());textToCopy=selection.toString()}else{textToCopy=contextMenuTarget.innerText||contextMenuTarget.textContent}}if(textToCopy){await clipboardAPI.writeText(textToCopy);clipboardText=textToCopy}}catch(error){console.error('复制失败:',error)}}async function pasteText(){const clipboardAPI=getClipboardAPI();if(!clipboardAPI||!contextMenuTarget)return;try{contextMenuTarget.focus();const text=await clipboardAPI.readText();if(!text)return;if(contextMenuTarget.tagName==='INPUT'&&contextMenuTarget.type==='number'){if(!/^[1-9]\d*$/.test(text.trim())){console.warn('粘贴失败：剪贴板内容不是正整数');return}}if(contextMenuTarget.tagName==='INPUT'||contextMenuTarget.tagName==='TEXTAREA'){const selection=savedSelection||{start:contextMenuTarget.selectionStart||0,end:contextMenuTarget.selectionEnd||0};const start=selection.start;const end=selection.end;const value=contextMenuTarget.value;contextMenuTarget.value=value.substring(0,start)+text+value.substring(end);contextMenuTarget.selectionStart=contextMenuTarget.selectionEnd=start+text.length;const event=new Event('input',{bubbles:true});contextMenuTarget.dispatchEvent(event)}else{const selection=window.getSelection();if(savedSelection){selection.removeAllRanges();selection.addRange(savedSelection.cloneRange())}const range=selection.getRangeAt(0);range.deleteContents();range.insertNode(document.createTextNode(text));range.collapse(false);const event=new Event('input',{bubbles:true});contextMenuTarget.dispatchEvent(event)}clipboardText=text}catch(error){console.error('粘贴失败:',error)}}async function cutText(){const clipboardAPI=getClipboardAPI();if(!clipboardAPI||!contextMenuTarget)return;try{if(contextMenuTarget.tagName==='INPUT'||contextMenuTarget.tagName==='TEXTAREA'){if(contextMenuTarget.type==='number'){console.warn('剪切操作在number类型的输入框中被禁用');return}contextMenuTarget.focus();const selection=savedSelection||{start:contextMenuTarget.selectionStart||0,end:contextMenuTarget.selectionEnd||0};const start=selection.start;const end=selection.end;if(start!==end){const text=contextMenuTarget.value.substring(start,end);await clipboardAPI.writeText(text);contextMenuTarget.value=contextMenuTarget.value.substring(0,start)+contextMenuTarget.value.substring(end);contextMenuTarget.selectionStart=contextMenuTarget.selectionEnd=start;clipboardText=text;const event=new Event('input',{bubbles:true});contextMenuTarget.dispatchEvent(event)}}}catch(error){console.error('剪切失败:',error)}}function toggleFullscreen(){if(!isFullscreen){const elem=document.documentElement;if(elem.requestFullscreen){elem.requestFullscreen()}else if(elem.webkitRequestFullscreen){elem.webkitRequestFullscreen()}else if(elem.msRequestFullscreen){elem.msRequestFullscreen()}isFullscreen=true;if(fullscreenStatus)fullscreenStatus.textContent='全屏模式'}else{if(document.exitFullscreen){document.exitFullscreen()}else if(document.webkitExitFullscreen){document.webkitExitFullscreen()}else if(document.msExitFullscreen){document.msExitFullscreen()}isFullscreen=false;if(fullscreenStatus)fullscreenStatus.textContent='窗口模式'}if(isMenuVisible){updateFullscreenMenuItem()}}function handleKeyboard(e){if(isMenuVisible){if(e.key==='Escape'){hideContextMenu()}else{e.preventDefault();e.stopPropagation()}return}if(e.key==='F5'){e.preventDefault();location.reload()}}function handleFullscreenChange(){isFullscreen=!!document.fullscreenElement;if(fullscreenStatus){fullscreenStatus.textContent=isFullscreen?'全屏模式':'窗口模式'}if(isMenuVisible){updateFullscreenMenuItem()}}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init)}else{init()}})();
